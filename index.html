<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Generador de Posts | n8n</title>
  <style>
    :root{
      color-scheme: light dark;
      --bg:#ffffff; --fg:#0f172a; --muted:#6b7280; --soft:rgba(127,127,127,.06);
      --stroke:rgba(127,127,127,.22); --primary:#111827; --accent:#2563eb;
      --radius:14px; --radius-sm:10px;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0f17; --fg:#e5e7eb; --soft:rgba(255,255,255,.05); --stroke:rgba(255,255,255,.18) }
    }
    *{box-sizing:border-box}
    body{
      margin:0 auto; padding:20px 16px; max-width:1200px;
      background:var(--bg); color:var(--fg);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      line-height:1.55;
    }
    h1{font-size:clamp(1.6rem,1.1rem + 1.2vw,2.1rem); margin:.25rem 0 1rem}
    h2{font-size:clamp(1.1rem,1.02rem + .4vw,1.3rem); margin:1rem 0 .6rem}
    .muted{color:var(--muted)}
    .card{background:var(--soft); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; margin:14px 0}
    input[type="url"], textarea, input[type="text"]{
      width:100%; padding:10px 12px; border-radius:var(--radius-sm);
      border:1px solid var(--stroke); background:transparent; color:inherit;
    }
    textarea{min-height:84px; resize:none}
    .cta{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px}
    button{padding:10px 14px; border-radius:12px; border:0; font-weight:600; cursor:pointer}
    button.primary{background:var(--primary); color:#fff}
    button.ghost{background:#f3f4f6; color:#111827}
    @media (prefers-color-scheme: dark){ button.ghost{background:#111827; color:#e5e7eb} }
    .spinner{width:18px;height:18px;border:3px solid rgba(0,0,0,.15);border-top-color:currentColor;border-radius:50%;display:inline-block;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--stroke);padding:4px 10px;border-radius:999px;margin:3px 4px 0 0;font-size:.85rem;background:#fff0}
    .chip button{all:unset; cursor:pointer; font-weight:700}

    .grid3{display:grid; gap:14px; grid-template-columns:repeat(3,1fr)}
    @media (max-width:900px){ .grid3{grid-template-columns:1fr 1fr} }
    @media (max-width:640px){ .grid3{grid-template-columns:1fr} }

    .post-card{
      border:1px solid var(--stroke); border-radius:12px; padding:10px; background:#fff0;
      display:grid; gap:8px; grid-template-rows:auto auto 1fr auto auto;
      transition: box-shadow .2s ease, border-color .2s ease;
    }
    .post-card.selected{ border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent) }
    .thumb{width:100%; aspect-ratio:16/10; border:1px solid var(--stroke); border-radius:10px; object-fit:cover; background:#fff}
    .post-text{
      font-size:.95rem; border:1px dashed var(--stroke); border-radius:10px; padding:8px; white-space:pre-wrap;
      max-height:150px; overflow:auto;
    }
    .post-actions{display:flex; justify-content:flex-end}

    .two-col{display:grid; gap:16px; grid-template-columns:1fr 1fr}
    @media (max-width:1000px){ .two-col{grid-template-columns:1fr} }

    .preview{
      border:1px solid var(--stroke); border-radius:12px; padding:14px; display:grid; gap:10px;
      background:var(--soft);
    }
    .preview .pimg{width:100%; aspect-ratio:16/9; border:1px solid var(--stroke); border-radius:12px; object-fit:cover; background:#fff}
    .kpi{display:flex; justify-content:space-between; color:var(--muted); font-size:.9rem}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row-inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input-hashtag{max-width:320px}
    .chips{display:flex;flex-wrap:wrap}
    .label-small{font-size:.9rem;color:var(--muted);margin:.2rem 0 .4rem}
  </style>
</head>
<body>
  <h1>Generar & Publicar</h1>

  <div class="card">
    <form id="form">
      <label for="url"><strong>URL de la noticia</strong></label>
      <input id="url" type="url" pattern="https?://.+" placeholder="https://www.tu-sitio.cl/mi-post/" required />
      <div class="cta">
        <button class="primary" type="submit" id="btn-generate">Generar propuestas</button>
        <button class="ghost" type="button" id="btn-demo">Demo</button>
        <span id="status" class="muted"></span>
      </div>
      <p class="muted">Genera 3 propuestas por red + imagen. Selecciona una tarjeta y edita abajo antes de publicar.</p>
    </form>
  </div>

  <!-- Tarjetas LinkedIn -->
  <section class="card" id="li-section" style="display:none">
    <h2>LinkedIn</h2>
    <div class="grid3" id="li-cards"></div>
  </section>

  <!-- Tarjetas Instagram -->
  <section class="card" id="ig-section" style="display:none">
    <h2>Instagram</h2>
    <div class="grid3" id="ig-cards"></div>
  </section>

  <!-- Previews lado a lado -->
  <section class="two-col" id="previews" style="display:none">
    <!-- LinkedIn -->
    <div class="card preview">
      <strong>Post seleccionado (LinkedIn)</strong>
      <img id="li-img" class="pimg" alt="Imagen LinkedIn" />
      <textarea id="li-editor" placeholder="Ajusta el texto si quieres…"></textarea>

      <div>
        <div class="label-small">Hashtags del post</div>
        <div id="li-post-chips" class="chips"></div>
      </div>

      <div class="row-inline">
        <label><input type="checkbox" id="li-include-post" checked> Incluir hashtags del post</label>
        <label><input type="checkbox" id="li-include-base" checked> Incluir hashtags base</label>
      </div>

      <div class="row-inline">
        <input id="li-add-tag" class="input-hashtag" type="text" placeholder="Agregar hashtag y Enter (#Salud …)" />
      </div>
      <div>
        <div class="label-small">Extras</div>
        <div id="li-extra-chips" class="chips"></div>
      </div>

      <div class="kpi"><span class="muted">Texto + hashtags al publicar</span><span id="li-count">0</span></div>
      <div class="post-actions">
        <button class="primary" id="publish-li" type="button">Publicar en LinkedIn</button>
      </div>
    </div>

    <!-- Instagram -->
    <div class="card preview">
      <strong>Post seleccionado (Instagram)</strong>
      <img id="ig-img" class="pimg" alt="Imagen Instagram" />
      <textarea id="ig-editor" placeholder="Ajusta el texto si quieres…"></textarea>

      <div>
        <div class="label-small">Hashtags del post</div>
        <div id="ig-post-chips" class="chips"></div>
      </div>

      <div class="row-inline">
        <label><input type="checkbox" id="ig-include-post" checked> Incluir hashtags del post</label>
        <label><input type="checkbox" id="ig-include-base" checked> Incluir hashtags base</label>
      </div>

      <div class="row-inline">
        <input id="ig-add-tag" class="input-hashtag" type="text" placeholder="Agregar hashtag y Enter (#Salud …)" />
      </div>
      <div>
        <div class="label-small">Extras</div>
        <div id="ig-extra-chips" class="chips"></div>
      </div>

      <div class="kpi"><span class="muted">Texto + hashtags al publicar</span><span id="ig-count">0</span></div>
      <div class="post-actions">
        <button class="primary" id="publish-ig" type="button">Publicar en Instagram</button>
      </div>
    </div>
  </section>

  <script>
    /* ====== Config ====== */
    const GENERATE_WEBHOOK_URL = 'http://localhost:5678/webhook/generate';
    const PUBLISH_WEBHOOK_URL  = 'http://localhost:5678/webhook/publish';

    /* ====== Helpers ====== */
    const $ = s => document.querySelector(s);
    const form = $('#form'), btnGenerate = $('#btn-generate'), btnDemo = $('#btn-demo'), statusEl = $('#status');

    const liSection = $('#li-section'), igSection = $('#ig-section'), previews = $('#previews');
    const liCards = $('#li-cards'), igCards = $('#ig-cards');
    const liImg = $('#li-img'), igImg = $('#ig-img');
    const liEditor = $('#li-editor'), igEditor = $('#ig-editor');
    const liPostChips = $('#li-post-chips'), igPostChips = $('#ig-post-chips');
    const liExtraChips = $('#li-extra-chips'), igExtraChips = $('#ig-extra-chips');
    const liAddTag = $('#li-add-tag'), igAddTag = $('#ig-add-tag');
    const liIncPost = $('#li-include-post'), igIncPost = $('#ig-include-post');
    const liIncBase = $('#li-include-base'), igIncBase = $('#ig-include-base');
    const liCount = $('#li-count'), igCount = $('#ig-count');
    const publishLI = $('#publish-li'), publishIG = $('#publish-ig');

    let lastPayload = null;
    let baseTags = [];
    let liPosts = [], igPosts = [];
    let liSelected = 0, igSelected = 0;
    let imageUrl = '';
    let liExtras = [], igExtras = [];

    function setBusy(busy, msg=''){
      btnGenerate.disabled = busy;
      statusEl.innerHTML = busy ? `<span class="spinner"></span> ${msg || 'Generando…'}` : '';
    }
    function autosize(t){ t.style.height='auto'; t.style.height=Math.min(480,Math.max(84,t.scrollHeight))+'px'; }
    function wireCounter(editor, counter){ const upd=()=>{counter.textContent = (editor.value||'').length + ' caracteres'; autosize(editor);}; editor.addEventListener('input',upd); upd(); }
    const normArr = v => Array.isArray(v)?v: (v? [v]:[]);
    const cleanTag = t => {
      if(!t) return '';
      let s = t.trim().replace(/[，,]+/g,''); // sin coma
      if(!s) return '';
      if(!s.startsWith('#')) s = '#'+s.replace(/^#+/,'');
      return s.replace(/\s+/g,''); // sin espacios internos
    };
    const uniq = arr => [...new Set(arr.filter(Boolean))];

    function parsePosts(raw){
      return (Array.isArray(raw)?raw:[]).map(x=>{
        if (typeof x === 'string') return { text:x.trim(), tags:[] };
        const text = (x.copy ?? x.text ?? '').toString().trim();
        const tags = normArr(x.hashtags).map(cleanTag).filter(Boolean);
        return { text, tags };
      }).filter(p=>p.text);
    }

    function chipsHtml(list, removable=false, onRemove){
      return list.map((t,idx)=>{
        const id = `${t}-${idx}-${Math.random().toString(36).slice(2,6)}`;
        return `<span class="chip" data-id="${id}">${t}${removable?`<button title="Quitar" data-remove="${idx}">×</button>`:''}</span>`;
      }).join('');
    }

    function renderRemovableChips(container, list, onRemove){
      container.innerHTML = chipsHtml(list, true);
      container.querySelectorAll('button[data-remove]').forEach(btn=>{
        btn.onclick = ()=> onRemove(Number(btn.dataset.remove));
      });
    }

    function renderCards(container, posts, onSelect){
      container.innerHTML = '';
      posts.slice(0,3).forEach((p,i)=>{
        const el = document.createElement('div');
        el.className = 'post-card' + (i===0?' selected':'');
        el.innerHTML = `
          <div class="chip">Post ${i+1}</div>
          <img class="thumb" alt="Imagen" src="${imageUrl||''}">
          <div class="post-text">${p.text.replace(/</g,'&lt;')}</div>
          <div class="muted">Hashtags</div>
          <div>${chipsHtml(p.tags)}</div>
          <div class="post-actions"><button class="ghost" type="button">Seleccionar</button></div>
        `;
        el.querySelector('button').onclick = ()=>{
          [...container.children].forEach(c=>c.classList.remove('selected'));
          el.classList.add('selected');
          onSelect(i);
        };
        container.appendChild(el);
      });
    }

    function applySelection(kind, idx){
      if (kind==='li'){
        liSelected = idx;
        liEditor.value = liPosts[idx]?.text || '';
        autosize(liEditor);
        liPostChips.innerHTML = chipsHtml(liPosts[idx]?.tags || []);
      } else {
        igSelected = idx;
        igEditor.value = igPosts[idx]?.text || '';
        autosize(igEditor);
        igPostChips.innerHTML = chipsHtml(igPosts[idx]?.tags || []);
      }
      updateCounters();
    }

    function buildBoards(data){
      baseTags = (data.hashtags_base || []).map(cleanTag).filter(Boolean);
      imageUrl = data.image_url || '';

      igPosts = parsePosts(data.instagram ?? data.instagram_options);
      liPosts = parsePosts(data.linkedin  ?? data.linkedin_options);

      // reset extras
      liExtras = []; igExtras = [];

      // Mostrar secciones
      liSection.style.display='block';
      igSection.style.display='block';
      previews.style.display='grid';

      // Render tarjetas
      renderCards(liCards, liPosts, (i)=>applySelection('li',i));
      renderCards(igCards, igPosts, (i)=>applySelection('ig',i));

      // Selección por defecto y recursos
      applySelection('li',0); applySelection('ig',0);
      liImg.src = imageUrl; igImg.src = imageUrl;

      renderRemovableChips(liExtraChips, liExtras, (i)=>{ liExtras.splice(i,1); renderRemovableChips(liExtraChips, liExtras, (i)=>{ liExtras.splice(i,1); renderRemovableChips(liExtraChips, liExtras, ()=>{}); updateCounters();}); updateCounters();});
      renderRemovableChips(igExtraChips, igExtras, (i)=>{ igExtras.splice(i,1); renderRemovableChips(igExtraChips, igExtras, ()=>{}); updateCounters();});

      wireCounter(liEditor, liCount);
      wireCounter(igEditor, igCount);
    }

    function finalHashtags(kind){
      const postTags = (kind==='li' ? (liPosts[liSelected]?.tags||[]) : (igPosts[igSelected]?.tags||[]));
      const incPost = (kind==='li' ? liIncPost.checked : igIncPost.checked);
      const incBase = (kind==='li' ? liIncBase.checked : igIncBase.checked);
      const extras  = (kind==='li' ? liExtras : igExtras);
      const all = uniq([ ...(incPost? postTags: []), ...(incBase? baseTags: []), ...extras ]);
      return all;
    }

    function buildFinalCaption(kind){
      const text = (kind==='li' ? liEditor.value : igEditor.value).trim();
      const tags = finalHashtags(kind);
      const tagsLine = tags.length ? '\n\n'+tags.join(' ') : '';
      return (text + tagsLine).trim();
    }

    function updateCounters(){
      liCount.textContent = buildFinalCaption('li').length + ' caracteres';
      igCount.textContent = buildFinalCaption('ig').length + ' caracteres';
    }

    function addExtra(kind, raw){
      const tag = cleanTag(raw);
      if(!tag) return;
      if(kind==='li'){
        if(!liExtras.includes(tag)) liExtras.push(tag);
        renderRemovableChips(liExtraChips, liExtras, (i)=>{ liExtras.splice(i,1); renderRemovableChips(liExtraChips, liExtras, ()=>{}); updateCounters();});
      }else{
        if(!igExtras.includes(tag)) igExtras.push(tag);
        renderRemovableChips(igExtraChips, igExtras, (i)=>{ igExtras.splice(i,1); renderRemovableChips(igExtraChips, igExtras, ()=>{}); updateCounters();});
      }
      updateCounters();
    }

    /* ====== Backend calls ====== */
    async function callGenerate(url){
      const r = await fetch(GENERATE_WEBHOOK_URL,{
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify({ url: encodeURI(url) })
      });
      if (!r.ok){ const t = await r.text().catch(()=> ''); throw new Error(`Fallo el webhook generate: ${r.status} ${t}`); }
      return r.json();
    }
    async function callPublish({ channel, caption, image_url }){
      const r = await fetch(PUBLISH_WEBHOOK_URL,{
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify({ channel, caption, image_url })
      });
      if (!r.ok){ const t = await r.text().catch(()=> ''); throw new Error(`Publicación falló: ${r.status} ${t}`); }
      return r.json().catch(()=>({ok:true}));
    }

    /* ====== Eventos ====== */
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const url = document.getElementById('url').value.trim();
      if (!url) return;
      try{
        setBusy(true, 'Procesando contenido en n8n…');
        const raw = await callGenerate(url);
        lastPayload = raw || {};
        buildBoards(lastPayload);
      }catch(err){ alert(err.message || err); }
      finally{ setBusy(false); }
    });

    btnDemo.addEventListener('click', ()=>{
      document.getElementById('url').value = 'https://www.centronuevaestoril.cl/infarto-en-mujeres-diagnostico-sintomas-nicolas-veas/';
    });

    // Agregar extras con Enter
    liAddTag.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); addExtra('li', liAddTag.value); liAddTag.value=''; }
    });
    igAddTag.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); addExtra('ig', igAddTag.value); igAddTag.value=''; }
    });

    // Recontar cuando cambian toggles
    [liIncPost, liIncBase, igIncPost, igIncBase].forEach(el=> el.addEventListener('change', updateCounters));

    // Publicar
    publishLI.addEventListener('click', async ()=>{
      try{
        const caption = buildFinalCaption('li');
        await callPublish({ channel:'linkedin', caption, image_url: imageUrl });
        alert('Publicado en LinkedIn ✅');
      }catch(e){ alert(e.message || e); }
    });

    publishIG.addEventListener('click', async ()=>{
      try{
        const caption = buildFinalCaption('ig');
        await callPublish({ channel:'instagram', caption, image_url: imageUrl });
        alert('Publicado en Instagram ✅');
      }catch(e){ alert(e.message || e); }
    });

    // Autocarga ?url=
    document.addEventListener('DOMContentLoaded', ()=>{
      const qp = (new URLSearchParams(location.search).get('url') || '').trim();
      if (qp){ document.getElementById('url').value = qp; form.dispatchEvent(new Event('submit')); }
    });
  </script>
</body>
</html>
